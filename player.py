# =================================================================
#               player.py - The Player Class Model
#
# Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ú©Ù„Ø§Ø³ Player Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ù‡Ø³ØªÙ‡ Ø§ØµÙ„ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª
# Ù‡Ø± Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯Ø± Ø¨Ø§Ø²ÛŒ Ø§Ø³Øª. Ù‡Ø± Ø´ÛŒØ¡ Ø§Ø² Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ØŒ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ú©Ø§Ù…Ù„
# Ø¨Ø§ ØªÙ…Ø§Ù… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ØŒ Ø¢Ù…Ø§Ø±ØŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ù…Ù†Ø·Ù‚ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø®ÙˆØ¯ Ø§Ø³Øª.
# =================================================================

# --- ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª Ø¨Ø§Ø²ÛŒ ---
# Ù…Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¯Ø§Ø®Ù„ÛŒ Ú©Ù„Ø§Ø³ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒÙ…
from gamedata import TITLES, CULTIVATION_PATHS, game_world

class Player:
    """
    Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ØŒ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø¨Ø§ ØªÙ…Ø§Ù… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒØ´ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
    """
    def __init__(self, user_id: int, telegram_name: str, path: str):
        # --- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆÛŒØªÛŒ ---
        self.user_id = user_id                  # Ø´Ù†Ø§Ø³Ù‡ Ø¹Ø¯Ø¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
        self.telegram_name = telegram_name      # Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù…
        self.in_game_name = telegram_name       # Ù†Ø§Ù… Ø´Ø®ØµÛŒØª Ø¯Ø± Ø¨Ø§Ø²ÛŒ (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ø¨Ø§ /setname)

        # --- Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ´Ø±ÙØª (Progression) ---
        self.path = path                        # Ù…Ø³ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: "ØªÙ‡Ø°ÛŒØ¨" ÛŒØ§ "Ù…Ø§Ù†Ø§"
        self.rank_index = 0                     # Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø±ØªØ¨Ù‡ ÙØ¹Ù„ÛŒ Ø¯Ø± Ù„ÛŒØ³Øª Ø±ØªØ¨Ù‡â€ŒÙ‡Ø§ (Ø´Ø±ÙˆØ¹ Ø§Ø² 0)
        self.xp = 0                             # Ù…ÛŒØ²Ø§Ù† ØªØ¬Ø±Ø¨Ù‡ ÙØ¹Ù„ÛŒ

        # --- Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ ---
        self.x = 0                              # Ù…Ø®ØªØµØ§Øª X Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡
        self.y = 0                              # Ù…Ø®ØªØµØ§Øª Y Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡

        # --- Ø¢Ù…Ø§Ø± Ùˆ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ (Attributes/Stats) ---
        self.stats = {
            'strength': 5,      # Ù‚Ø¯Ø±Øª
            'agility': 5,       # Ú†Ø§Ø¨Ú©ÛŒ
            'stamina': 100,     # Ø§Ø³ØªÙ‚Ø§Ù…Øª
            'intelligence': 5   # Ù‡ÙˆØ´
        }
        self.attribute_points = 0 # Ø§Ù…ØªÛŒØ§Ø²Ø§ØªÛŒ Ú©Ù‡ Ù¾Ø³ Ø§Ø² ØµØ¹ÙˆØ¯ Ø¨Ù‡ Ø±ØªØ¨Ù‡ Ø¨Ø§Ù„Ø§ØªØ± Ø¨Ø±Ø§ÛŒ ØªØ®ØµÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

        # --- Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ú©ÙˆØ¦Ø³Øªâ€ŒÙ‡Ø§ ---
        self.learned_skills = []                # Ù„ÛŒØ³Øª Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ ÛŒØ§Ø¯ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡
        self.active_quests = {}                 # Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ú©ÙˆØ¦Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
        self.completed_quests = []              # Ù„ÛŒØ³Øª Ú©ÙˆØ¦Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡

    # --- Ù…ØªØ¯Ù‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾ÛŒØ´Ø±ÙØª Ùˆ Ø±ØªØ¨Ù‡ ---

    def get_rank_info(self) -> dict:
        """Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±ØªØ¨Ù‡ ÙØ¹Ù„ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø§Ø² gamedata Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
        try:
            return CULTIVATION_PATHS[self.path][self.rank_index]
        except (KeyError, IndexError):
            # Ø§Ú¯Ø± Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ù‡ Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ø±ØªØ¨Ù‡ Ø±Ø³ÛŒØ¯Ù‡ Ø¨Ø§Ø´Ø¯
            return {"rank_name": "Ø§ÙØ³Ø§Ù†Ù‡ Ø²Ù†Ø¯Ù‡", "xp_needed": float('inf')}

    def get_title(self) -> str:
        """Ù„Ù‚Ø¨ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ØªØ¨Ù‡ Ø§Ùˆ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
        current_title = "Ø¨ÛŒâ€ŒÙ„Ù‚Ø¨"
        for rank_req, title in TITLES.items():
            if self.rank_index >= rank_req:
                current_title = title
        return current_title

    def add_xp(self, amount: int):
        """Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø®ØµÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
        self.xp += amount

    def can_breakthrough(self) -> bool:
        """Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¢ÛŒØ§ XP Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ø±Ø§ÛŒ ØµØ¹ÙˆØ¯ Ø¨Ù‡ Ø±ØªØ¨Ù‡ Ø¨Ø¹Ø¯ÛŒ Ú©Ø§ÙÛŒ Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±."""
        rank_info = self.get_rank_info()
        return self.xp >= rank_info['xp_needed']

    def perform_breakthrough(self) -> str:
        """Ø¹Ù…Ù„ÛŒØ§Øª ØµØ¹ÙˆØ¯ Ø¨Ù‡ Ø±ØªØ¨Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."""
        if self.can_breakthrough():
            self.rank_index += 1
            self.xp = 0  # Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ØªØ¬Ø±Ø¨Ù‡ Ù¾Ø³ Ø§Ø² ØµØ¹ÙˆØ¯
            self.attribute_points += 1 # Ø¬Ø§ÛŒØ²Ù‡: ÛŒÚ© Ø§Ù…ØªÛŒØ§Ø² ÙˆÛŒÚ˜Ú¯ÛŒ
            
            new_rank_info = self.get_rank_info()
            return f"Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ø±ØªØ¨Ù‡ {new_rank_info['rank_name']} ØµØ¹ÙˆØ¯ Ú©Ø±Ø¯ÛŒØ¯!"
        return "Ø´Ø±Ø§ÛŒØ· Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ ØµØ¹ÙˆØ¯ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯."

    # --- Ù…ØªØ¯Ù‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨Ø§Ø²ÛŒÚ©Ù† ---

    def set_name(self, new_name: str):
        """Ù†Ø§Ù… Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."""
        self.in_game_name = new_name

    def move(self, direction: str) -> bool:
        """Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ Ø¯Ø± Ø¬Ù‡Øª Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ Ø­Ø±Ú©Øª Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯Ù† Ø­Ø±Ú©Øª Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯."""
        new_x, new_y = self.x, self.y

        if direction == "up": new_y += 1
        elif direction == "down": new_y -= 1
        elif direction == "left": new_x -= 1
        elif direction == "right": new_x += 1

        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø®ØªØµØ§Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø²ÛŒ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±
        if (new_x, new_y) in game_world:
            self.x, self.y = new_x, new_y
            return True # Ø­Ø±Ú©Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯
        return False # Ø­Ø±Ú©Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯

    def get_status_text(self) -> str:
        """ÛŒÚ© Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ùˆ ÙØ±Ù…Øªâ€ŒØ´Ø¯Ù‡ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""
        rank_info = self.get_rank_info()
        status_message = (
            f"ğŸ‘¤ **Ù†Ø§Ù…:** {self.in_game_name}\n"
            f"ğŸ– **Ù„Ù‚Ø¨:** {self.get_title()}\n\n"
            f"âš”ï¸ **Ù…Ø³ÛŒØ±:** {self.path}\n"
            f"ğŸ’  **Ø±ØªØ¨Ù‡:** {rank_info['rank_name']}\n"
            f"âœ¨ **ØªØ¬Ø±Ø¨Ù‡ (XP):** {self.xp} / {rank_info['xp_needed']}\n\n"
            f"**----- Ø¢Ù…Ø§Ø± -----**\n"
            f"ğŸ’ª **Ù‚Ø¯Ø±Øª:** {self.stats['strength']}\n"
            f"ğŸƒâ€â™‚ï¸ **Ú†Ø§Ø¨Ú©ÛŒ:** {self.stats['agility']}\n"
            f"â¤ï¸ **Ø§Ø³ØªÙ‚Ø§Ù…Øª:** {self.stats['stamina']}\n"
            f"ğŸ§  **Ù‡ÙˆØ´:** {self.stats['intelligence']}\n"
        )
        if self.attribute_points > 0:
            status_message += f"\n**â­ï¸ Ø´Ù…Ø§ {self.attribute_points} Ø§Ù…ØªÛŒØ§Ø² ÙˆÛŒÚ˜Ú¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ®ØµÛŒØµ Ø¯Ø§Ø±ÛŒØ¯!**"
        
        return status_message

